
ACTIVATE Cloud SQL Admin API


>> gcloud sql instances describe instance-for-taskdb                                      exercise307  ✭ ✱
API [sqladmin.googleapis.com] not enabled on project [26772408224]. Would you like to enable and retry (this will 
take a few minutes)? (y/N)?  y

PROVIDE THE GOOGLE SERVICE ACCOUNT (GSA) TO THE Cloud SQL Auth proxy

    ADD REQUIRED IAM ROLES TO THE SERVICE ACCOUNT:

    gcloud projects add-iam-policy-binding dwk-gke-360910 \
    --member="serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com" \
    --role="roles/cloudsql.client"

    gcloud projects add-iam-policy-binding dwk-gke-360910 \
    --member="serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com" \
    --role="roles/logging.logWriter"

    ADD ALSO CLOUDSQL USER RIGHTS TO Compute Engine default service account

ENABLE GKE WORKLOAD IDENTITY 

    UPDATE EXISTING CLUSTER TO USE WORKLOAD IDENTITY

    gcloud container clusters update dwk-cluster
    --zone=europe-north1-b
    --workload-pool=dwk-gke-360910.svc.id.goog

    ADD KUBERNETES SERVICE ACCOUNT (KSA) TO CLUSTER using KSA name 'ksa-cloud-sql'

    kubectl apply -f manifests/service-account.yaml

    ENABLE IAM BINDING BETWEEN GSA AND KSA

    gcloud iam service-accounts add-iam-policy-binding \
    --role="roles/iam.workloadIdentityUser" \
    --member="serviceAccount:dwk-gke-360910.svc.id.goog[exercise307/ksa-cloud-sql]" \
    github-actions@dwk-gke-360910.iam.gserviceaccount.com
   
    ADD AN ANNOTATION TO THE KSA NAME

    kubectl annotate serviceaccount \
    ksa-cloud-sql \
    iam.gke.io/gcp-service-account=github-actions@dwk-gke-360910.iam.gserviceaccount.com

UPDATE manifests/

    INCLUDE SIDECAR 'cloud-sql-proxy' INTO THE STATEFULSET. FOR PODS, THE MySQL ADDRESS IS THEN 127.0.0.1:3306