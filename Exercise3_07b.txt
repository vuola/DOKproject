
ACTIVATE Cloud SQL Admin API

>> gcloud sql instances describe instance-for-taskdb                                      exercise307  ✭ ✱
API [sqladmin.googleapis.com] not enabled on project [26772408224]. Would you like to enable and retry (this will 
take a few minutes)? (y/N)?  y

ENABLE WORKLOAD IDENTITY AT CLUSTER STARTUP

gcloud container clusters create dwk-cluster \
--zone=europe-north1-b \
--region=europe-north1 \
--workload-pool=dwk-gke-360910.svc.id.goog

... OR ENABLE GKE WORKLOAD IDENTITY FOR EXISTING CLUSTER

    UPDATE EXISTING CLUSTER TO USE WORKLOAD IDENTITY

    gcloud container clusters update dwk-cluster
    --zone=europe-north1-b
    --workload-pool=dwk-gke-360910.svc.id.goog

    UPDATE CURRENT NODEPOOL TO USE WORKLOAD IDENTITY

    gcloud container node-pools update default-pool \
    --zone=europe-north1-b \
    --cluster=dwk-cluster \
    --workload-metadata=GKE_METADATA

ENABLE THE CLUSTER AS THE DEFAULT CLUSTER 

gcloud container clusters get-credentials dwk-cluster \
--region europe-north1-b

CREATE A GOOGLE SERVICE ACCOUNT (GSA) 

gcloud iam service-accounts create service-account-GKE-CSQL \
--display-name="Service account providing GKE access to CSQL"

PROVIDE THE GSA WITH IAM ACCESS RIGHTS:

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com" \
--role="roles/cloudsql.client"

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com" \
--role="roles/cloudsql.editor"

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:p26772408224-mhoyvp@gcp-sa-cloud-sql.iam.gserviceaccount.com" \
--role="roles/logging.logWriter"

    ?? ADD ALSO CLOUDSQL USER RIGHTS TO Compute Engine default service account ??

BUILD GSA-KSA BINDINGS

    ADD KUBERNETES SERVICE ACCOUNT (KSA) TO CLUSTER using KSA name 'ksa-cloud-sql'

    kubectl apply -f manifests/service-account.yaml

    ENABLE IAM BINDING BETWEEN GSA AND KSA

gcloud iam service-accounts add-iam-policy-binding \
--role="roles/iam.workloadIdentityUser" \
--member="serviceAccount:dwk-gke-360910.svc.id.goog[exercise307/ksa-cloud-sql]" \
service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com
 
    ADD AN ANNOTATION TO THE KSA NAME

kubectl annotate serviceaccount \
ksa-cloud-sql  \
iam.gke.io/gcp-service-account=service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com

UPDATE manifests/

    INCLUDE SIDECAR 'cloud-sql-proxy' INTO THE STATEFULSET. FOR PODS, THE MySQL ADDRESS IS THEN 127.0.0.1:3306



    *******************


Stack trace:
#0 /var/www/html/api/read.php(17): Task->getTasks()
#1 {main}
  thrown in /var/www/html/class/tasks.php on line 26" while reading response header from upstream, client: 10.28.0.1, server: _, request: "GET /api/read.php HTTP/1.1", upstream: "fastcgi://unix:/run/php-fpm.sock:", host: "taskproject-svc:8081"
10.28.0.1 -  [09/Jan/2023:11:29:04 +0000] "GET /api/read.php HTTP/1.1" 500 []
2023/01/09 11:29:04 [error] 10#10: *21815 FastCGI sent in stderr: "PHP message: PHP Fatal error:  Uncaught Error: Call to a member function prepare() on null in /var/www/html/class/tasks.php:26
Stack trace:
#0 /var/www/html/api/read.php(17): Task->getTasks()
#1 {main}
  thrown in /var/www/html/class/tasks.php on line 26" while reading response header from upstream, client: 10.28.0.1, server: _, request: "GET /api/read.php HTTP/1.1", upstream: "fastcgi://unix:/run/php-fpm.sock:", host: "taskproject-svc:8081"
NOTICE: PHP message: PHP Fatal error:  Uncaught Error: Call to a member function prepare() on null in /var/www/html/class/tasks.php:26

TESTING PROXY: GRANT ME ACCESS
gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="user:markus.vuolahti@gmail.com" \
--role="roles/cloudsql.client"

DOWNLOAD PROXY
wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy

MAKE IT EXECUTABLE
chmod +x cloud_sql_proxy

INSPECT CONNECTION NEEDED TO CLOUD SQL
gcloud sql instances describe instance-for-taskdb
>> connectionName: dwk-gke-360910:europe-north1:instance-for-taskdb
>> - ipAddress: 172.23.176.3
>> type: PRIVATE

USE START-UP OPTION FOR PRIVATE NETWORK CONNECTION
-ip_address_types=PRIVATE

INVOCATION 1
./cloud_sql_proxy -instances=dwk-gke-360910:europe-north1:instance-for-taskdb=tcp:3306
mysql -u USERNAME -p -h HOST-OR-SERVER-IP 

INVOCATION 2
./cloud_sql_proxy -instances=dwk-gke-360910:europe-north1:instance-for-taskdb=tcp:3306
mysql -u USERNAME -p --host 127.0.0.1

PHP message: PHP Fatal error:  Uncaught PDOException: SQLSTATE[HY000] [2006] MySQL server has gone away

Correctly working ADMINER request
[Tue Jan 10 21:00:27 2023] [::ffff:35.191.0.88]:51200 
[200]: GET /?server=127.0.0.1%3A3306&username=vuola&db=taskdb
[Tue Jan 10 21:00:27 2023] [::ffff:35.191.0.88]:51200 Closing
[Tue Jan 10 21:00:27 2023] [::ffff:35.191.0.85]:59378 Accepted
[Tue Jan 10 21:00:27 2023] [::ffff:35.191.0.85]:59378 [200]: GET /?server=127.0.0.1%3A3306&username=vuola&db=taskdb&script=db
[Tue Jan 10 21:00:27 2023] [::ffff:35.191.0.85]:59378 Closing
[Tue Jan 10 21:00:39 2023] [::ffff:35.191.0.104]:32768 Accepted

curl taskproject-svc:8081/api/read.php

10.28.3.1 -  [11/Jan/2023:09:37:09 +0000] "GET /api/read.php HTTP/1.1" 500 []
2023/01/11 09:37:09 [error] 10#10: *1 FastCGI sent in stderr: "PHP message: PHP Fatal error:  Uncaught PDOException: SQLSTATE[HY000] [2006] MySQL server has gone away in /var/www/html/config/database.php:47
Stack trace:
#0 /var/www/html/config/database.php(47): PDO->__construct()
#1 /var/www/html/api/read.php(9): Database::getConnection()
#2 {main}

Next RuntimeException: Could not connect to the Cloud SQL Database. Check that your username and password are correct, that the Cloud SQL proxy is running, and that the database exists and is ready for use. For more assistance, refer to https://cloud.google.com/sql/docs/mysql/connect-external-app. The PDO error was SQLSTATE[HY000] [2006] MySQL server has gone away in /var/www/html/config/database.php:73
Stack trace:
#0 /var/www/html/api/read.php(9): Database::getConnection()
#1 {main}
  thrown in /var/www/html/config/database.php on line 73" while reading response header from upstream, client: 10.28.3.1, server: _, request: "GET /api/read.php HTTP/1.1", upstream: "fastcgi://unix:/run/php-fpm.sock:", host: "taskproject-svc:8081"
  

  sudo apt install -y \ 
  php8.1-ctype \
  php8.1-curl \
  php8.1-dom \
  php8.1-fpm \
  php8.1-gd \
  php8.1-intl \
  php8.1-mbstring \
  php8.1-pdo \
  php8.1-pdo_mysql \
  php8.1-mysqli \
  php8.1-opcache \
  php8.1-openssl \
  php8.1-phar \
  php8.1-session \
  php8.1-xml \
  php8.1-xmlreader \
  php8.1-zlib

  ADD:
  php81-mysqlnd \