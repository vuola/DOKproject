
ACTIVATE Cloud SQL Admin API

>> gcloud sql instances describe instance-for-taskdb                                      exercise307  ✭ ✱
API [sqladmin.googleapis.com] not enabled on project [26772408224]. Would you like to enable and retry (this will 
take a few minutes)? (y/N)?  y

ENABLE WORKLOAD IDENTITY AT CLUSTER STARTUP

gcloud container clusters create dwk-cluster \
--zone=europe-north1-b \
--region=europe-north1 \
--workload-pool=dwk-gke-360910.svc.id.goog

... OR ENABLE GKE WORKLOAD IDENTITY FOR EXISTING CLUSTER

    UPDATE EXISTING CLUSTER TO USE WORKLOAD IDENTITY

    gcloud container clusters update dwk-cluster
    --zone=europe-north1-b
    --workload-pool=dwk-gke-360910.svc.id.goog

    UPDATE CURRENT NODEPOOL TO USE WORKLOAD IDENTITY

    gcloud container node-pools update default-pool \
    --zone=europe-north1-b \
    --cluster=dwk-cluster \
    --workload-metadata=GKE_METADATA

ENABLE THE CLUSTER AS THE DEFAULT CLUSTER 

gcloud container clusters get-credentials dwk-cluster \
--region europe-north1-b

CREATE A GOOGLE SERVICE ACCOUNT (GSA) 

gcloud iam service-accounts create service-account-GKE-CSQL \
--display-name="Service account providing GKE access to CSQL"

PROVIDE THE GSA WITH IAM ACCESS RIGHTS:

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com" \
--role="roles/cloudsql.client"

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com" \
--role="roles/cloudsql.editor"

gcloud projects add-iam-policy-binding dwk-gke-360910 \
--member="serviceAccount:p26772408224-mhoyvp@gcp-sa-cloud-sql.iam.gserviceaccount.com" \
--role="roles/logging.logWriter"

    ?? ADD ALSO CLOUDSQL USER RIGHTS TO Compute Engine default service account ??

BUILD GSA-KSA BINDINGS

    ADD KUBERNETES SERVICE ACCOUNT (KSA) TO CLUSTER using KSA name 'ksa-cloud-sql'

    kubectl apply -f manifests/service-account.yaml

    ENABLE IAM BINDING BETWEEN GSA AND KSA

gcloud iam service-accounts add-iam-policy-binding \
--role="roles/iam.workloadIdentityUser" \
--member="serviceAccount:dwk-gke-360910.svc.id.goog[exercise307/ksa-cloud-sql]" \
service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com
 
    ADD AN ANNOTATION TO THE KSA NAME

kubectl annotate serviceaccount \
ksa-cloud-sql  \
iam.gke.io/gcp-service-account=service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com

UPDATE manifests/

    INCLUDE SIDECAR 'cloud-sql-proxy' INTO THE STATEFULSET. FOR PODS, THE MySQL ADDRESS IS THEN 127.0.0.1:3306



    *******************

    Updated IAM policy for project [dwk-gke-360910].
bindings:
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/artifactregistry.admin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/cloudsql.admin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/datamigration.admin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/iam.securityAdmin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/iam.serviceAccountAdmin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/iam.serviceAccountKeyAdmin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/owner
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/resourcemanager.organizationAdmin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/resourcemanager.projectIamAdmin
- members:
  - user:markus.vuolahti@gmail.com
  role: roles/storage.objectAdmin
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/artifactregistry.repoAdmin
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  - serviceAccount:service-26772408224@gcp-sa-artifactregistry.iam.gserviceaccount.com
  role: roles/artifactregistry.serviceAgent
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/cloudfunctions.developer
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/container.developer
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/container.hostServiceAgentUser
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/iam.workloadIdentityUser
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/storage.admin
- members:
  - serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/cloudsql.editor
- members:
  - serviceAccount:dwk-gke-360910.svc.id.goog[exercise307/ksa-cloud-sql]
  role: roles/iam.workloadIdentityUser
- members:
  - serviceAccount:26772408224@cloudbuild.gserviceaccount.com
  role: roles/cloudbuild.builds.builder
- members:
  - serviceAccount:service-26772408224@compute-system.iam.gserviceaccount.com
  role: roles/compute.serviceAgent
- members:
  - serviceAccount:service-26772408224@container-engine-robot.iam.gserviceaccount.com
  role: roles/container.serviceAgent
- members:
  - serviceAccount:service-26772408224@gcp-sa-cloudbuild.iam.gserviceaccount.com
  role: roles/cloudbuild.serviceAgent
- members:
  - serviceAccount:service-26772408224@gcp-sa-datamigration.iam.gserviceaccount.com
  role: roles/datamigration.serviceAgent
- members:
  - serviceAccount:service-26772408224@gcp-sa-networkmanagement.iam.gserviceaccount.com
  role: roles/networkmanagement.serviceAgent
- members:
  - serviceAccount:service-26772408224@gcp-sa-pubsub.iam.gserviceaccount.com
  role: roles/pubsub.serviceAgent
- members:
  - serviceAccount:service-26772408224@service-networking.iam.gserviceaccount.com
  role: roles/servicenetworking.serviceAgent
- members:
  - serviceAccount:26772408224-compute@developer.gserviceaccount.com
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  - serviceAccount:p26772408224-mhoyvp@gcp-sa-cloud-sql.iam.gserviceaccount.com
  - serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/cloudsql.client
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  - serviceAccount:p26772408224-mhoyvp@gcp-sa-cloud-sql.iam.gserviceaccount.com
  - serviceAccount:service-account-GKE-CSQL@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/logging.logWriter
- members:
  - serviceAccount:26772408224-compute@developer.gserviceaccount.com
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  role: roles/cloudsql.instanceUser
- members:
  - serviceAccount:github-actions@dwk-gke-360910.iam.gserviceaccount.com
  - serviceAccount:service-26772408224@containerregistry.iam.gserviceaccount.com
  role: roles/containerregistry.ServiceAgent
- members:
  - serviceAccount:26772408224-compute@developer.gserviceaccount.com
  - serviceAccount:26772408224@cloudservices.gserviceaccount.com
  role: roles/editor
etag: BwXxxELJXYc=
version: 1
